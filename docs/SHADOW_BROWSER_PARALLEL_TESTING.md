# 影子浏览器并行测试功能说明

## 概述

Aegis 现在支持智能的影子浏览器并行测试功能，可以根据不同模式自动调整浏览器数量，显著提升测试效率。

## 功能特点

### 1. 模式自适应

#### 被动模式
- **使用 1 个影子浏览器进行交互分析**
- 专注于无感监听和复现用户交互
- 最小化资源占用
- 保持最佳的用户体验

#### 主动模式（自主模式）
- **可使用多个影子浏览器**（默认 5 个）
- AI 智能判断需要多少个并行浏览器
- 自动分配测试任务到不同浏览器
- 最大化测试覆盖率

### 2. 智能并行策略

AI 会根据页面分析自动决定：
- 哪些功能点可以并行测试
- 如何分配浏览器资源
- 需要启动多少个并行任务

#### 示例场景：
1. **表单测试**：一个浏览器测试登录，另一个测试注册
2. **功能探索**：同时测试不同的页面功能模块
3. **漏洞扫描**：并行测试不同的输入点

### 3. 配置选项

```yaml
browser_pool:
  # 被动模式浏览器数量（固定为1）
  passive_mode_pool_size: 1
  
  # 主动模式浏览器数量（可调整）
  active_mode_pool_size: 5
  
  # 兼容性配置
  pool_size: 3
```

## 实现细节

### 1. 动态浏览器池

- InvestigationManager 根据执行模式自动选择池大小
- 被动模式：1 个浏览器（无感监听）
- 主动模式：最多 5 个浏览器（并行测试）

### 2. 并行任务执行器

- `ParallelTaskExecutor`：协调多个浏览器的任务执行
- 智能任务分配算法
- 自动负载均衡

### 3. AI 智能编排

- `SmartParallelOrchestrator`：让 AI 决定并行策略
- 基于页面分析生成最优测试方案
- 动态调整并行度

## 使用方法

### 1. 配置执行模式

```yaml
investigation_manager:
  # 被动模式：1个浏览器
  execution_mode: 'passive'
  
  # 或主动模式：多个浏览器
  execution_mode: 'autonomous'
```

### 2. 启动系统

系统会自动根据模式配置相应的浏览器数量：
- 被动模式：看到 "已创建统一并发信号量，最大并发数: 1 (模式: passive)"
- 主动模式：看到 "已创建统一并发信号量，最大并发数: 5 (模式: autonomous)"

### 3. 监控并行执行

在自主模式下，你会看到类似日志：
```
设置 3 个并行浏览器进行测试
已初始化并行执行器，可使用 3 个影子浏览器
执行并行测试任务...
并行执行完成，共 5 个结果
```

## 性能优化

### 1. 资源管理
- 自动复用浏览器实例
- 智能上下文管理
- 内存使用优化

### 2. 任务调度
- 避免任务冲突
- 智能重试机制
- 超时控制

### 3. 状态同步
- 保持认证状态同步
- 实时状态更新
- 跨浏览器状态共享

## 注意事项

1. **资源限制**：每个浏览器实例都会消耗内存和CPU，请根据机器配置调整 `active_mode_pool_size`

2. **网站兼容性**：某些网站可能检测并阻止多浏览器访问，建议在测试前了解目标网站的限制

3. **网络带宽**：多个浏览器同时工作会增加网络负载，确保网络环境支持

4. **调试复杂度**：并行执行会增加调试难度，建议在遇到问题时先使用单个浏览器进行复现

## 未来改进

1. **动态扩缩容**：根据任务复杂度动态调整浏览器数量
2. **智能任务优先级**：自动排序高价值测试任务
3. **跨浏览器协作**：支持浏览器间的状态共享和协作测试
4. **性能监控**：实时监控资源使用情况，自动优化配置