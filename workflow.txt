sequenceDiagram
    participant Filter as 过滤器
    participant Summarizer as 🤖 JS摘要器
    participant Correlator as 上下文关联器
    participant CorrelationAI as 🤖 关联分析器
    participant LLM as LLM服务
    participant Reporter as 报告/记忆器

    Note over Filter, Reporter: Aegis v4 - "摘要-关联" 工作流

    Filter->>Summarizer: 1. 发现JS文件，发送进行摘要
    activate Summarizer
    Summarizer->>LLM: 2. 请求对JS代码进行摘要
    LLM-->>Summarizer: 3. 返回JS代码摘要
    Summarizer->>Correlator: 4. 将(JS事件+摘要)发送给关联器
    deactivate Summarizer

    loop 并行发生
        Filter->>Correlator: 5. 发现网络请求，直接发送给关联器
    end

    activate Correlator
    Note over Correlator: 持续收集网络请求和“已摘要的JS”<br/>直到满足触发条件 (关键行为/超时)
    deactivate Correlator
    
    Correlator->>CorrelationAI: 6. 打包发送完整的上下文（包含请求和JS摘要）
    activate CorrelationAI
    Note over CorrelationAI: 开始最终的关联分析
    CorrelationAI->>LLM: 7. (RAG后)发送包含摘要的大师级Prompt
    LLM-->>CorrelationAI: 8. 返回最终的JSON格式漏洞报告
    deactivate CorrelationAI

    CorrelationAI->>Reporter: 9. (通过广播器)将最终结果发送到输出模块
    activate Reporter
    Reporter->>Reporter: 10. 解析JSON并生成报告/存入记忆
    deactivate Reporter