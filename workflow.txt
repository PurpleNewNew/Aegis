
sequenceDiagram
    participant User as 用户
    participant Browser as 浏览器
    participant Correlator as 上下文关联器
    participant HolisticAI as 整体分析Worker
    participant Prompts as prompts.py
    participant LLM_VDB as Ollama & ChromaDB
    participant Reporter as 报告Worker
    participant Memory as 记忆Worker

    Note over User, Memory: 整个流程由一个中央的“上下文关联器”驱动，它负责收集并打包数据。

    User->>Browser: 1. 浏览目标网站 (例如, 打开登录页)
    Browser-->>Correlator: 2. 发送页面所有相关事件 (JS文件, 网络请求等)
    
    activate Correlator
    Note over Correlator: 持续收集与登录页相关的所有事件，<br/>构建一个完整的“页面扫描上下文”。
    deactivate Correlator

    User->>Browser: 3. 执行关键操作 (例如, 点击登录按钮)
    Browser-->>Correlator: 4. 发送登录时的POST请求事件

    activate Correlator
    Note over Correlator: 收到关键操作的信号，认为上下文已完整。
    Correlator->>HolisticAI: 5. **打包**所有相关信息(JS代码, 登录请求等)，<br/>作为一个“整体分析任务”发送。
    deactivate Correlator

    activate HolisticAI
    HolisticAI->>Prompts: 6. 获取“大师级”Prompt
    Note over HolisticAI: 开始RAG流程
    HolisticAI->>LLM_VDB: 7. 查询与当前上下文相关的记忆
    LLM_VDB-->>HolisticAI: 8. 返回记忆片段
    
    Note over HolisticAI: **将JS代码、网络请求、历史记忆等所有信息<br/>组合成一个极其丰富的Prompt**
    HolisticAI->>LLM_VDB: 9. 请求进行**整体性**关联分析
    LLM_VDB-->>HolisticAI: 10. 返回结构化的JSON分析结果
    deactivate HolisticAI

    HolisticAI->>Reporter: 11a. (通过广播器)发送结果到报告器
    activate Reporter
    Reporter->>Reporter: 12a. 遍历并写入所有发现
    deactivate Reporter

    HolisticAI->>Memory: 11b. (通过广播器)发送结果到记忆器
    activate Memory
    Memory->>LLM_VDB: 12b. 遍历并将新知识存入记忆
    deactivate Memory

