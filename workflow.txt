
sequenceDiagram
    participant User as 用户
    participant Browser as 浏览器
    participant Controller as 数据采集器
    participant Filter as 过滤器
    participant Writer as Jsonl写入器
    participant FileBuffer as data/capture.jsonl

    participant Reader as Jsonl读取器
    participant Dispatcher as 智能调度员
    participant SpecAI as 专精AI Worker
    participant LLM_VDB as Ollama & ChromaDB
    participant AILog as logs/ai_dialogues.jsonl
    participant Broadcaster as 广播器
    participant Reporter as 报告Worker
    participant Memory as 记忆Worker

    User->>Browser: 浏览目标网站

    par 捕获流水线
        loop 实时捕获
            Browser-->>Controller: 1. 发送CDP事件
            Controller-->>Filter: 2. 原始事件入队
            Filter-->>Writer: 3. (检查白名单后)精炼上下文入队
            Writer-->>FileBuffer: 4. 追加写入JSON行
        end
    and 分析流水线
        loop 实时分析
            Reader-->>FileBuffer: 5. 追踪(tail)文件变化
            Reader-->>Dispatcher: 6. 新任务入队
            Dispatcher-->>SpecAI: 7. 任务分发至专属AI队列
            
            activate SpecAI
            Note over SpecAI: 开始RAG流程
            SpecAI->>LLM_VDB: 8. 查询相关记忆
            LLM_VDB-->>SpecAI: 9. 返回记忆片段
            SpecAI->>LLM_VDB: 10. 组合Prompt, 请求分析
            LLM_VDB-->>SpecAI: 11. 返回分析结果
            deactivate SpecAI

            SpecAI->>AILog: 12. 记录完整对话
            SpecAI->>Broadcaster: 13. 分析结果入队

            par 并行最终处理
                Broadcaster-->>Reporter: 14a. 广播至报告队列
                Reporter-->>Reporter: 15a. 写入Markdown报告
            and
                Broadcaster-->>Memory: 14b. 广播至记忆队列
                Memory-->>LLM_VDB: 15b. 将新发现存入记忆
            end
        end
    end
