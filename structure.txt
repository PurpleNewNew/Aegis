
graph TD
    subgraph "阶段一：捕获 & 关联"
        direction LR
        User[👤 用户] --> Browser(🌐 Chrome浏览器)
        Browser -- "CDP事件流" --> Controller[CDP控制器]
        Controller --> Q_Raw[原始事件队列]
        Q_Raw --> Filter[过滤器Worker]
        Filter --> Q_Filtered[精炼事件队列]
        Q_Filtered --> Correlator{上下文关联器<br/>(核心大脑)}
    end

    subgraph "阶段二：整体性分析"
        direction LR
        Correlator -- "打包完整上下文" --> Q_Analysis[分析任务队列]
        Q_Analysis --> HolisticAI[🤖 整体分析Worker]
    end

    subgraph "外部服务 & 日志"
        direction TB
        Prompts([📄<br/>prompts.py])
        LLM_VDB[LLM服务 (Ollama)<br/>&<br/>向量数据库 (ChromaDB)]
        AILog([📄<br/>logs/ai_dialogues.jsonl])
    end

    subgraph "阶段三：广播 & 输出"
        direction LR
        HolisticAI -- "结构化JSON" --> Q_Out[统一AI结果队列]
        Q_Out --> Broadcaster[广播器]
        Broadcaster --> Q_Report[报告队列]
        Broadcaster --> Q_Memory[记忆队列]

        subgraph "并行最终处理"
            direction TB
            Q_Report --> Reporter(报告生成器)
            Q_Memory --> Memory(记忆沉淀器)
        end
        Reporter -- "写入结构化报告" --> ReportFile([📄<br/>reports/*.md])
    end

    %% 交互关系
    HolisticAI -- "调用大师级Prompt" --> Prompts
    HolisticAI -- "RAG/推理" --> LLM_VDB
    HolisticAI -- "记录对话" --> AILog
    Memory -- "写入记忆" --> LLM_VDB

    classDef stage fill:#E8F8F5,stroke:#16A085,stroke-width:2px
    classDef services fill:#FEF9E7,stroke:#F1C40F,stroke-width:2px
    class User,Browser,ReportFile,AILog,LLM_VDB,Prompts services
    class Controller,Filter,Correlator,HolisticAI,Broadcaster,Reporter,Memory,Q_Raw,Q_Filtered,Q_Analysis,Q_Out,Q_Report,Q_Memory stage
